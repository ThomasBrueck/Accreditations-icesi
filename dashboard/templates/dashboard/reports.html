{% extends 'dashboard/base-dashboard.html' %}
{% load static %}

{% block title %}
Reports
{% endblock %}

{% block css_files %}
<link rel='stylesheet' href="{% static 'dashboard/dashboard.css' %}">
<link rel='stylesheet' href="{% static 'dashboard/sidebar.css' %}"> 
<link rel='stylesheet' href="{% static 'dashboard/reports.css' %}">
<link rel='stylesheet' href="{% static 'dashboard/include/confirm-window.css' %}">
<style>
    .filter-section { display: none; margin-bottom: 20px; }
    .filter-section.active { display: block; }
    .filter-indicator { font-size: 0.8rem; color: #6c757d; margin-left: 5px; background-color: #e9ecef; padding: 2px 6px; border-radius: 3px; }
    .filter-button { cursor: pointer; }
</style>
{% endblock %}

{% block js_files %}
<script src="{% static 'dashboard/js/confirm-window.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterButton = document.querySelector('.filter-button');
        const filterSection = document.querySelector('.filter-section');
        const applyFilterButton = document.querySelector('#apply-filters');
        const clearFilterButton = document.querySelector('#clear-filters');

        filterButton.addEventListener('click', function() {
            filterSection.classList.toggle('active');
        });

        applyFilterButton.addEventListener('click', function() {
            filterSection.querySelector('form').submit();
        });

        clearFilterButton.addEventListener('click', function() {
            const form = filterSection.querySelector('form');
            form.querySelectorAll('input, select').forEach(input => input.value = '');
            form.submit();
        });
    });
</script>
{% endblock %}


{% block content %}

{% include 'dashboard/include/sidebar.html' %}
{% include 'dashboard/include/navbar.html' %}

<input type="checkbox" id="sidebar-toggle" class="d-none">

<div class="main-content">
    <div class="container-fluid py-4">

        <!-- Search and Actions Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="search-container">
            <form method="get" action="{% url 'report-list' %}" class="d-flex">
                <div class="input-group">
                    <span class="input-group-text bg-primary border-0 text-white">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="search" class="form-control border-0 bg-primary text-white" 
                           placeholder="Search report..." value="{{ search_query }}">
                </div>
                <!-- Preserve filter parameters -->
                {% for key, value in request.GET.items %}
                    {% if key != 'search' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
              </form>
          </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light d-flex align-items-center gap-2 filter-button">
                  Filter
                </button>
                {% if user.role.name == 'acadi' or user.role.name == 'program director' %}
                  <a href="{% url 'create-report' %}" class="btn btn-primary d-flex align-items-center gap-2">
                    Create report
                  </a>
                {% endif %}
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section card shadow-sm p-4">
          <form method="get" action="{% url 'report-list' %}">
              <div class="row g-3">
                  <div class="col-md-3">
                      <label class="form-label">Name</label>
                      {{ filter_form.name }}
                  </div>
                  <div class="col-md-3">
                      <label class="form-label">Status</label>
                      {{ filter_form.status }}
                  </div>
                  <div class="col-md-3">
                      <label class="form-label">Created by</label>
                      {{ filter_form.created_by }}
                  </div>
                  <div class="col-md-3">
                      <label class="form-label">End date</label>
                      {{ filter_form.end_date }}
                  </div>
              </div>
              <!-- Preserve the search query -->
              {% if search_query %}
                  <input type="hidden" name="search" value="{{ search_query }}">
              {% endif %}
              <div class="d-flex justify-content-end mt-3">
                  <button type="button" id="clear-filters" class="btn btn-outline-secondary me-2">Clear Filters</button>
                  <button type="button" id="apply-filters" class="btn btn-primary">Apply Filters</button>
              </div>
          </form>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if active_filters.name or active_filters.status or active_filters.created_by or active_filters.end_date %}
          <div class="mb-3">
              Active filters:
              {% if active_filters.name %}<span class="filter-indicator">Name: {{ active_filters.name }}</span>{% endif %}
              {% if active_filters.status %}<span class="filter-indicator">Status: {{ active_filters.status }}</span>{% endif %}
              {% if active_filters.created_by %}<span class="filter-indicator">Created by: {{ active_filters.created_by }}</span>{% endif %}
              {% if active_filters.end_date %}<span class="filter-indicator">End date: {{ active_filters.end_date|date:"d/m/Y" }}</span>{% endif %}
          </div>
        {% endif %}

        <!-- Team Members Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Reports <span class="text-muted small">{{ paginator.count }} Reports</span></h5>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th scope="col" class="text-center">Name <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
                                <th scope="col" class="text-center">Status <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
                                <th scope="col" class="text-center">Created by <i class="bi bi-info-circle text-muted ms-1"></i></th>
                                <th scope="col" class="text-center">End date <i class="bi bi-info-circle text-muted ms-1"></i></th>
                                <th scope="col" class="text-center">Actions</th>

                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>  
                              <td>
                                <div class="d-flex align-items-center">
                                  {% if report.image %}
                                    <img src="{{ report.image.url }}" alt="{{ report.name }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                  {% else %}
                                    <div class="avatar-circle bg-primary text-white me-2">
                                      {{ report.name|slice:":2"|upper }}
                                    </div>
                                  {% endif %}
                                  <div>{{ report.name }}</div>
                                </div>
                              </td>
                              <td class="text-center">
                                {% if report.status == 'active' %}
                                  <span class="badge bg-success">Active</span>
                                {% elif report.status == 'inactive' %}
                                  <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                              </td>
                              <td class="text-center">{{ report.created_by.username }}</td>
                              <td class="text-center">{{ report.end_date|date:"d/m/Y" }}</td>
                              <td class="text-center">
                                <div class="d-inline-flex justify-content-center gap-2">
                                  <a href="{% url 'view-report' report.id %}" class="btn btn-sm btn-primary">View</a>
                                  {% if user.role.name == 'acadi' or user.role.name == 'program director' %}
                                    <a href="{% url 'update-report' report.id%}" class="btn btn-sm btn-primary">Edit</a>

                                    <form method="post" action="{% url 'delete-report' report.pk %}" class="delete-form" id="deleteForm{{ report.pk }}">
                                      {% csrf_token %}
                                      <button type="button" class="btn btn-sm btn-danger triggerDeleteModal" data-form-id="deleteForm{{ report.pk }}">
                                        Remove
                                      </button>
                                    </form>
                                  {% endif %}
                                </div>
                              </td>
                            </tr>
                            {% empty %}
                            <tr>
                              <td colspan="5" class="text-center py-4">
                                <p class="mb-0 text-muted">No reports available</p>
                                {% if user.role.name == 'acadi' or user.role.name == 'program director' %}
                                  <a href="{% url 'create-report' %}" class="btn btn-primary mt-2">Create report</a>
                                {% endif %}
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                          
                    </table>
                </div>
            </div>
            
            {% if is_paginated %}
            <div class="card-footer bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-sm btn-link text-decoration-none">
                            Previous
                        </a>
                    {% else %}
                        <button class="btn btn-sm btn-link text-decoration-none" disabled>
                            Previous
                        </button>
                    {% endif %}
                    
                    <div class="pagination-numbers">
                        {% for i in paginator.page_range %}
                            {% if page_obj.number == i %}
                                <button class="btn btn-sm btn-primary rounded-circle">{{ i }}</button>
                            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                                <a href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-sm btn-light rounded-circle">{{ i }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-sm btn-link text-decoration-none">
                            Next
                        </a>
                    {% else %}
                        <button class="btn btn-sm btn-link text-decoration-none" disabled>
                            Next
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<div id="deleteModal" class="custom-modal">
  <div class="custom-modal-content">
    <h5 class="mb-3">Confirm Delete</h5>
    <p>Are you sure you want to delete this report? This action cannot be undone.</p>
    <div class="d-flex justify-content-end gap-2 mt-4">
      <button type="button" class="btn btn-outline-secondary cancel-delete-btn">Cancel</button>
      <button type="button" class="btn btn-danger confirm-delete-btn">Delete</button>
    </div>
  </div>
</div>
  
  
  
{% endblock %}